---
title: "Дизайн принципы синхронного API"
weight: 10
type: docs
---

Отлично сконструированный REST API привлекает других разработчиков его использовать. Идеальное API интуитивно понятное для разработчиков, в нём легко разобраться.

{{< blocks/section color="white" >}}
{{% blocks/feature icon="fa-wheelchair" title="Уровень 0<br />Легаси" %}}
Единственный URI и HTTP метод (как правило POST) и использование XML.
{{% /blocks/feature %}}

{{% blocks/feature icon="fab fa-accessible-icon" title="Уровень 1<br />Ресурсы" %}}
Каждому ресурсу отдельный эндпоинт, можно и на JSON перейти.
{{% /blocks/feature %}}

{{% blocks/feature icon="fa-motorcycle" title="Уровень 2<br />HTTP-глаголы" %}}
Используем правильные HTTP методы, статус коды, поддерживаем фильтрацию, пагинацию, поиск, сортировку и версионирование.
{{% /blocks/feature %}}
{{< /blocks/section >}}

Наша стратегия — **достигнуть 2 уровня на всех API компании**. 

## Построение URI
```
https:// api.leroymerlin.ru / domain / application / v1 / products?siteId=12&statusCode=active
\_____/\___________________/\_______/\____________/\___/\_________/\___________________________/
 схема        хост            домен      система  версия  ресурс     параметры запроса
                                          
```

#### Используй `spinal-case` для URL-ов и `camelCase` для параметров и аттрибутов.

* У каждого ресурса свой эндпоинт.
* Название ресурса всегда в множественном числе.
* Если ресурс относится к другому, используй вложенноссть.
* Максимальная вложенность — 1.
{{% alert color="danger" %}}
<code>/suppliers/{id}/products/{id}/media/{id}</code> слишком глубоко
{{% /alert %}}
* Допускается использование единственного числа там, где других таких же предметов быть не может
{{% alert color="success" %}}
<code>/delivery/v1/products</code> не бывает иных обьектов `delivery`
{{% /alert %}}

{{% alert color="success" title="Хорошие примеры" %}}
<code>/customers</code> все кастомеры <br />
<code>/customers/{id}/addresses</code> все адреса конкретного кастомера <br />
<code>/products?supplierId={supplierId}</code> список продуктов по поставщику <br />
<code>/products/{id}</code> детали определённого продукта <br />
<code>/products/{id}/media</code> список медиа одного продукта
{{% /alert %}}

#### Умеренная гранулярность.
Не надо возвращать информацию, которую не спрашивали.

{{% alert color="danger" title="/clients/1/address" %}}
<pre>{
  “road”: “121 rue Chanzy”,
  “city”: “Hellemmes”,
  “country”: “France”,
  <b><s>“age”: 22</s></b> — возраст здесь лишний
}
</pre>
{{% /alert %}}

#### Используй Суррогатные ключи правильно.
Суррогатный ключ — это ключ, искуственно сгенерированый системой. Не надо путать суррогатный ключ с первичным ключом базы данных. Ещё бывают натуральные ключи, сформированные из атрибутов, существующих в реальной жизни. 

В REST API качестве ключа по возможности следует использовать натуральные ключи, а также стоит избегать использования первичных ключей БД, так как при смене базы данных, у нас могут быть проблемы с интеграцией, да и вообще — это не секьюрно.

{{% alert color="success" title="Хорошие примеры" %}}
<code>/some-resource?tag=green</code> натуральный ключ “green” понятен пользователям<br />
<code>/customer/0012345</code> кастомер ID - суррогатный ключ для этого API
{{% /alert %}}

{{% alert color="danger" title="Плохие примеры" %}}
<code>/some-resource?tag=1</code> вернуть всё с тегом «green» через его id «1»<br />
<code>/customer/23dde7-e89b-12d3-a456-4265</code> кастомер ID это UUID, сгенерированный БД
{{% /alert %}}

## HTTP-методы

* `GET` получить
* `POST` создать
* `PUT` перезаписать
* `PATCH` частично обновить
* `DELETE` удалить
* `OPTIONS` вернуть все HTTP-методы, доступные для эндпоинта

{{% alert color="danger" title="Некорректное поведение" %}}
* использование везде только POST
* использование кастомных HTTP методов
* использоваие паттерна `/collections/{resource}:{action}`
{{% /alert %}}

## URL параметры запросов

#### Заголовки
Содержит технические параметры или элементы контекста.
```
Content-Type: application/json
ADEO-BU-CODE: 10
```

#### Path параметры
Эти параметры — часть URL. С их помощью можно понять, к какому ресурсу мы обращаемся.
{{% alert color="success" %}}
`/product/{id}/stocks` 
{{% /alert %}}

#### Query параметры
Позволяют фильтровать и сортировать запросы.

{{% alert color="success" title="Хорошие примеры" %}}
`/products?q=Luke+man` поиск продукта по тексту <br />
`/products?storeId=35` фильтрация продуктов по параметру магазина 35 <br />
`/products?sort=name&desc=age,id` сортировка по возростанию name и убыванию age, а затем id.
{{% /alert %}}

## Пагинация

{{% alert color="success" title="Хорошие примеры" %}}
`?page=2&perPage=100` по номеру страницы <br />
`?limit=25&before=ZDMyNz6yORI3OTLo` по курсору<br />
`?limit=25&offset=50` через оффсет & лимит<br />
`?limit=25&since=1364849754` через временные метки
{{% /alert %}}

В качестве ключа для пагинации по временным меткам используется Unix timestamp.  <br />Не стоит хранить курсоры: они быстро становятся невалидными из-за вставки или удаления элементов.

## Ответ: Общие правила

* Структура ответа HTTP не должна зависеть от структуры БД
* Все поля должны быть понятны с бизнес точки зрения
* Все наименования полей должны быть простыми, интуитивными и согласованными
* Стоит избегать использование технических терминов и специфических терминов систем

## Ответ: Статус коды
#### Все методы
* Для всех эндпоинтов необходимо возвращать статус коды.
* Каждый сервис потенциально должен уметь возвращать 500-ки.
* Каждый сервис, требующий как минимум один обязательный параметр на вход, должен уметь возвращать 400-ки с описанием ошибки
* Каждый секьюрный сервис должен уметь возвращать 401-ую ошибку.

#### GET
* Каждый сервис в случае отсутствия данных должен возвращать 404
* Каждая коллекция обязана вернуть 200, если возвращается полностью
* Каждая коллекция должна вернуть 206, если возвращается частично

#### PUT & PATCH:
* Каждый запрос, добавляющий обьекты должен возвращать 201. 

#### DELETE
* Каждый сервис должен возвращать 204.

## Ответ: Коды ошибок
Вместе с HTTP кодами ответов в теле необходимо указать код ошибки. Это позволит потребителю понять что именно пошло не так и правильно среагировать. Ответ с ошибкой может содержать бизнес код ошибки с описанием причины падения. Все эти коды должны быть описаны в документации API. 

Один из популярных форматов описания ошибок JSON-API: 
```
{
  "errors": [{
    "code": "ERR-01234",
    "title": "OAuth Exception",
    "details": "Session has expired at unix time 1385243766.", 
    "links": {
      "about": "http://example.com/docs/errors/#ERR-01234"
    }
  }]
}
```

Или вот кусок кода в формате Сваггера с описанием кода ответа и кода ошибок:
```
{ 
  Responses:
    ”200”:
      description: mySuccessResponse
  Schema:
    type: array
  Items:
    $ref: “#/definitions/Pet”,
    “400”: 
      description: Invalid status value
}
```

## Ответы: Формат данных
#### E.164 – Телефонный номер
***[+][код страны][код местности][местный номер]***

* `+` знак плюса
* `код страны` международный код страны
* `код местности` код местности без 0 в начале
* `местный номер` местный номер телефона

#### ISO 639 – Язык

* `eng` – Английский 
* `fra` – Французский
* `rus` – Русский

#### ISO 3166-1 — Язык

* `Russia (Russian Federation) Россия` `RU` `RUS` `643`
* `France` `Франция` `FR` `FRA` `250`
* `China` `Китай` `CN` `CHN` `156`

#### ISO 8601 – Дата

* `YYYY-MM` 2020-06
* `YYYYMMDD` 20200602
* `YYYY-MM-DDThh:mm:ss` 2020-06-02T15:22:00
* `YYYY-MM-DDThh:mm:ss±hh` 2020-06-02T15:22:00+03:00

#### ISO 4217 — Деньги

* `EUR` `978` – Евро
* `USD` `840` - Доллар США
* `KZT` `398` – Тенге
* `BYN` `933` - Беларусский Рубль

#### UCUM – Меры измерения

Все меры измерения ищите в [UCUM specification](https://unitsofmeasure.org/).